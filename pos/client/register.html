<!DOCTYPE html>
<html>
<head>

<title>Register</title>
<meta name="viewport" content="initial-scale=1.0">

<!-- Source Sans Pro -->
<link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,600" rel="stylesheet" type="text/css">

<!-- Application styles -->
<link href="style/main.css" rel="stylesheet" type="text/css">
<link href="style/login.css" rel="stylesheet" type="text/css">
<link href="style/register.css" rel="stylesheet" type="text/css">

<!-- Date and time formatting -->
<script src="http://cdnjs.cloudflare.com/ajax/libs/moment.js/2.6.0/moment.min.js" type="text/javascript"></script>

<!-- Emulation -->
<script src="http://kaazing.kevinhoyt.com:8001/demo/jms/javascript/WebSocket.js" type="text/javascript"></script>

<!-- JMS -->
<script src="http://kaazing.kevinhoyt.com:8001/demo/jms/javascript/JmsClient.js" type="text/javascript"></script>

<script type="text/javascript">
var TOPIC_NAME = "/topic/pos";
var WEBSOCKET_URL = "ws://kaazing.kevinhoyt.com:8001/jms";

var connection = null;
var consumer = null;
var future = null;
var model = null;
var producer = null;
var session = null;
var interval = null;
var topic = null;
var touch = null;

// Update login status message
// Incremental updates to track clock
function updateStatus()
{
    var status = null;

    // Update status message
    status = document.querySelector( ".message" );
    status.innerHTML = moment().format( "dddd, MMMM D @ h:mm A" );

    // Setup interval if none present
    if( interval == null )
    {
        interval = setInterval( updateStatus, 1000 );
    }
}

// Called when the charge button is clicked
// Initiates payment process
function doChargeClick()
{
    var message = null;
    var start = null;
    var total = null;

    total = this.innerHTML;

    start = total.indexOf( "$" ) + 1;
    total = total.substr( start );

    message = {
        action: "present",
        amount: parseFloat( total )
    };

    producer.send(
        session.createTextMessage( JSON.stringify( message ) ),
        doMessageSent
    );
}

// Called when connected to server
// Subscribes to topics
function doConnected()
{
    var status = null;

    status = document.querySelector( ".dialog .message" );

    try {
        // Connection
        connection = future.getValue();
        status.innerHTML = "Subscribing to topics ...";

        // Session
        // Topic
        session = connection.createSession( false, Session.AUTO_ACKNOWLEDGE );
        topic = session.createTopic( TOPIC_NAME );

        // Consumer
        // Set listener
        consumer = session.createConsumer( topic );
        consumer.setMessageListener( doMessageArrived );

        // Producer
        producer = session.createProducer( topic );

        // Start broker session
        connection.start( doSessionStart );
    } catch( e ) {
        // Fail
        console.log( "Exception: " + e );
    }
}

// Called when login button is pressed
// Starts connection to server and login process
function doLoginClick()
{
    var clerk = null;
    var factory = null;
    var status = null;

    // Get clerk ID
    // Phone number of attendee
    clerk = document.querySelector( ".dialog input" );
    model.clerkId = clerk.value;
    clerk.blur();

    // Stop updating the time
    clearInterval( interval );

    // Start socket connection
    status = document.querySelector( ".dialog .message" );
    status.innerHTML = "Connecting ...";

    // Debug
    // Tracer.setTrace( true );

    // Use JMS as broker
    factory = new JmsConnectionFactory( WEBSOCKET_URL );

    // Connect to server
    future = factory.createConnection(
        null,           // User name
        null,           // Password
        doConnected     // Callback
    );
}

// Called when a message has arrived
function doMessageArrived( message )
{
    console.log( "Arrived: " + message.getText() );
}

// Called when a message has been sent
// Verification of send
function doMessageSent()
{
    console.log( "Message sent." );
}

// Called when broker session started
function doSessionStart()
{
    var status = null;

    status = document.querySelector( ".dialog .message" );
    status.innerHTML = "Getting product listing ...";

    var splash = document.querySelector( ".splash" );
    splash.style.visibility = "hidden";

    var register = document.querySelector( ".register" );
    register.style.visibility = "visible";

    window.scrollTo( 0, 0 );
}

// Called when window loads
// Setup application
function doWindowLoad()
{
    var charge = null;
    var login = null;

    // Check to see if there is a touch event handler
    touch = ( "ontouchstart" in document.documentElement ) ? true : false;

    // Application data model
    model = {
        clerkId: null,
        registerId: Math.round( new Date().getTime() / 1000 )
    };

    // Login event listener
    login = document.querySelector( ".splash > .dialog > .login" );
    login.addEventListener( touch ? "touchstart" : "click", doLoginClick );

    // Charge event listener
    charge = document.querySelector( ".total .charge" );
    charge.addEventListener( touch ? "touchstart" : "click", doChargeClick );

    // Register status message
    updateStatus();

    // Layout
    doWindowResize();
}

// Called when window resizes
// Layout screen to fit
function doWindowResize()
{
    var dialog = null;

    // Center login dialog
    dialog = document.querySelector( "div.splash > .dialog" );
    dialog.style.left = ( ( window.innerWidth - dialog.clientWidth ) / 2 ) + "px";
    dialog.style.top = ( ( window.innerHeight - dialog.clientHeight ) / 2 ) + "px";
}

// Get things going
window.addEventListener( "load", doWindowLoad );
window.addEventListener( "resize", doWindowResize );
</script>

</head>
<body>

<!-- Login screen -->
<div class="screen splash">

    <!-- Dialog -->
    <div class="dialog">

        <!-- Clerk ID -->
        <div class="clerk">Clerk ID:</div>
        <input type="number">
        <div class="login">Login</div>

        <!-- Status -->
        <div class="message"></div>

    </div>

</div>

<!-- Register screen -->
<div class="screen register">

    <!-- Product listing -->
    <div class="layout">

        <!-- Row 1 -->
        <div class="product"></div>
        <div class="product"></div>
        <div class="product"></div>
        <div class="product"></div>
        <div class="product"></div>

        <!-- Row 2 -->
        <div class="product"></div>
        <div class="product"></div>
        <div class="product"></div>
        <div class="product"></div>
        <div class="product"></div>

        <!-- Row 3 -->
        <div class="product"></div>
        <div class="product"></div>
        <div class="product"></div>
        <div class="product"></div>
        <div class="product"></div>

        <!-- Row 4 -->
        <div class="product"></div>
        <div class="product"></div>
        <div class="product"></div>
        <div class="product"></div>
        <div class="product"></div>

        <!-- Item template -->
        <div class="item">
            <img src="img/apple-biscuit-lg.png" width="92" height="79">
            <div class="label">Apple Biscuit</div>
        </div>

        <div class="item" style="left: 137px;">
            <img src="img/oatmeal-rasin-lg.png" width="92" height="79">
            <div class="label">Oatmeal Rasin</div>
        </div>

        <div class="item" style="left: 488px;">
            <img src="img/janssons-frestelse-lg.png" width="92" height="79">
            <div class="label">Janssons Frestelse</div>
        </div>

        <div class="item" style="left: 488px; top: 137px;">
            <img src="img/dobos-torta-lg.png" width="92" height="79">
            <div class="label">Dobos Torta</div>
        </div>

    </div>

    <!-- Right side summary -->
    <div class="summary">

        <!-- Header -->
        <div class="total">
            <div class="logo"></div>
            <div class="charge ready">Charge: $21.65</div>
        </div>

        <!-- Item list -->
        <div class="list">
            <div class="line">
                <div class="photo" style="background-image: url( 'img/apple-biscuit-sm.png' );"></div>
                <div class="label">Apple Biscuit</div>
                <div class="duplicate">2</div>
                <div class="price">$9.00</div>
            </div>
            <div class="line">
                <div class="photo" style="background-image: url( 'img/oatmeal-rasin-sm.png' );"></div>
                <div class="label">Oatmeal Rasin</div>
                <div class="duplicate" style="display: none;">2</div>
                <div class="price">$3.00</div>
            </div>
            <div class="line">
                <div class="photo" style="background-image: url( 'img/janssons-frestelse-sm.png' );"></div>
                <div class="label">Janssons Frestelse</div>
                <div class="duplicate" style="display: none;">2</div>
                <div class="price">$5.00</div>
            </div>
            <div class="line">
                <div class="photo" style="background-image: url( 'img/dobos-torta-sm.png' );"></div>
                <div class="label">Dobos Torta</div>
                <div class="duplicate" style="display: none;">2</div>
                <div class="price">$3.00</div>
            </div>

            <!-- Tax -->
            <div class="line tax">
                <div class="photo">%</div>
                <div class="label">Tax</div>
                <div class="rate">(8.25%)</div>
                <div class="price">$1.65</div>
            </div>

            <!-- Clear -->
            <div class="clear">
                Clear List
            </div>
        </div>

        <!-- Transaction -->
        <div class="footer">Transaction #1234</div>

    </div>

</div>

</body>
</html>
