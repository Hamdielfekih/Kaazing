<!DOCTYPE html>
<html>
<head>

<title>Black Box</title>

<!-- Big shout out to iHUD for the inspiration -->
<!-- Check out their iOS application -->
<!-- http://www.i-hud.com -->

<!-- Styles -->
<!-- Mostly inline SVG -->
<style type="text/css">
body {
    margin: 0px;
    overflow: hidden;
    padding: 0px;
}

.airspeed {
    height: 75%;
    position: absolute;
    left: 20px;
    top: 20px;
    width: 86px;
}

.altimeter {
    height: 75%;
    position: absolute;
    right: 20px;
    top: 20px;
    width: 68px;
}

.dial {
    position: absolute;
    width: 12%;
}

.heading {
    height: 75%;
    position: absolute;
}

.humidity {
    left: 200px;
}

.map {
    bottom: 0px;
    left: 0px;
    position: absolute;
    right: 0px;
    top: 0px;
}

.pitch {
    position: absolute;
    height: 75%;
}

.position {
    position: absolute;
    height: 75%;
}

.tilt {
    position: absolute;
    height: 75%;
}
</style>

<!-- Emulation -->
<script src="http://kevinhoyt.com/kaazing/4.0.4/WebSocket.js" type="text/javascript"></script>

<!-- JMS -->
<script src="http://kevinhoyt.com/kaazing/4.0.4/jms/JmsClient.js" type="text/javascript"></script>

<!-- Animation -->
<script src="http://cdnjs.cloudflare.com/ajax/libs/gsap/1.11.5/TweenLite.min.js" type="text/javascript"></script>

<!-- Map -->
<script src="https://maps.googleapis.com/maps/api/js?sensor=false" type="text/javascript"></script>

<!-- Gauges -->
<script src="Airspeed.js" type="text/javascript"></script>
<script src="Altimeter.js" type="text/javascript"></script>
<script src="Dial.js" type="text/javascript"></script>
<script src="Heading.js" type="text/javascript"></script>
<script src="Pitch.js" type="text/javascript"></script>
<script src="Position.js" type="text/javascript"></script>
<script src="Tilt.js" type="text/javascript"></script>

<!-- Application -->
<script type="text/javascript">
// User interface constants
var KAAZING_LATITUDE = 37.4173652;
var KAAZING_LONGITUDE = -121.9788182;

// Data constants
var TOPIC_NAME = "/topic/telemetry";
var WEBSOCKET_URL = "ws://localhost:8001/jms";

// Global user interface
var airspeed = null;
var altimeter = null;
var attitude = null;
var heading = null;
var interval = null;
var map = null;
var pitch = null;
var position = null;
var temperature = null;
var touch = null;

// Global data
var connection = null;
var consumer = null;
var future = null;
var session = null;
var topic = null;

// Update the situational display
function updateSituation( values )
{
    var newAirspeed = Math.random() * 35;
    var newAltitude = Math.random() * 3000;
    var newHeading = Math.random() * 360;
    var newPitch = Math.random() * 50;
    var newTilt = Math.random() * 45;
    var newTemperature = temperature.minimum + ( Math.random() * 81 );
    var newHumidity = humidity.minimum + ( Math.random() * 70 );

    if( Math.random() > 0.50 )
    {
        newPitch = 0 - newPitch;
    }

    if( Math.random() > 0.50 )
    {
        newTilt = 0 - newTilt;
    }

    // TODO: Center map on new coordinates

    airspeed.setAirspeed( newAirspeed );
    altimeter.setAltitude( newAltitude );
    pitch.setPitch( newPitch );
    pitch.setTilt( newTilt );
    tilt.setTilt( newTilt );
    heading.setHeading( newHeading );
    temperature.setValue( newTemperature );
    humidity.setValue( newHumidity );
}

// Called when connected to server
// Not yet connected to broker
function doConnected()
{
    try {
        // Connection
        connection = future.getValue();
        console.log( "Connection established." );

        // Session
        // Topic
        session = connection.createSession( false, Session.AUTO_ACKNOWLEDGE );
        topic = session.createTopic( TOPIC_NAME );

        // Consumer
        // Set listener
        consumer = session.createConsumer( topic );
        consumer.setMessageListener( doMessageArrived );

        // Start broker session
        connection.start( doSessionStart );
    } catch( e ) {
        // Fail
        console.log( "Exception: " + e );
    }
}

// Handle toggle of heading source
function doHeadingClick()
{
    if( heading.getSource() == heading.SOURCE_COMPASS )
    {
        heading.setSource( heading.SOURCE_GPS );
    } else {
        heading.setSource( heading.SOURCE_COMPASS );
    }
}

// Called when a message has arrived
// Parses data and updates user interface
function doMessageArrived( message )
{
    console.log( "Arrived: " + message.getText() );
}

// Called when broker session started
// Kick off periodic message send
function doSessionStart()
{
    console.log( "JMS session created." );
}

// Setup map
function doMapLoad()
{
    var options = null;

    // Center on Kaazing HQ
    // Hide most default UI
    // Disable dragging
    options = {
        center: new google.maps.LatLng( KAAZING_LATITUDE, KAAZING_LONGITUDE ),
        zoom: 18,
        disableDefaultUI: true,
        draggable: false,
        scaleControl: true,
        zoomControl: false,
        zoomControlOptions: {
            position: google.maps.ControlPosition.BOTTOM_CENTER,
            style: google.maps.ZoomControlStyle.LARGE
        }
    };

    // Create map instance
    map = new google.maps.Map( document.querySelector( ".map" ), options );
}

// Called when the window loads
// Initializes DOM references
function doWindowLoad()
{
    var factory = null;

    // Click or touch
    touch = ( 'ontouchstart' in document.documentElement ) ? true : false;

    // Airspeed
    airspeed = new Airspeed( ".airspeed" );
    // airspeed.setAirspeed( 12 );

    // Altimeter
    altimeter = new Altimeter( ".altimeter" );
    // altimeter.setAltitude( 1234 );

    // Heading
    heading = new Heading( ".heading" );
    heading.source.addEventListener( touch ? "touchstart" : "mousedown", doHeadingClick );
    // heading.setHeading( 123 );

    // Position
    position = new Position( ".position" );

    // Pitch
    pitch = new Pitch( ".pitch" );
    // pitch.setPitch( 12 );
    // pitch.setTilt( 34 );

    // Tilt
    tilt = new Tilt( ".tilt" );
    // tilt.setTilt( 12 );

    // Temperature
    temperature = new Dial( ".dial.temperature", "Temp (\u00B0F)", 41, 122 );
    // temperature.setValue( 56.78 );

    // Humidity
    humidity = new Dial( ".dial.humidity", "RH (%)", 10, 90 );
    // humidity.setValue( 12.34 );

    // Fit to window
    // Components only draw once
    // Subsequent window resize only positions components
    doWindowResize();

    // Pretend values for testing
    // interval = setInterval( updateSituation, 2000 );

    // Debug
    // Tracer.setTrace( true );

    // Use JMS as broker
    factory = new JmsConnectionFactory( WEBSOCKET_URL );

    // Connect to server
    future = factory.createConnection(
        null,           // User name
        null,           // Password
        doConnected     // Callback
    );
}

// Called to layout user interface
function doWindowResize()
{
    airspeed.container.style.top = Math.round( ( window.innerHeight - airspeed.container.clientHeight ) / 2 ) + "px";

    altimeter.container.style.top = Math.round( ( window.innerHeight - altimeter.container.clientHeight ) / 2 ) + "px";

    heading.container.style.top = ( Math.round( ( window.innerHeight - heading.container.clientHeight ) / 2 ) - 16 ) + "px";
    heading.container.style.left = Math.round( ( window.innerWidth - heading.container.clientWidth ) / 2 ) + "px";

    position.container.style.top = Math.round( ( window.innerHeight - position.container.clientHeight ) / 2 ) + "px";
    position.container.style.left = Math.round( ( window.innerWidth - position.container.clientWidth ) / 2 ) + "px";

    pitch.container.style.top = Math.round( ( window.innerHeight - pitch.container.clientHeight ) / 2 ) + "px";
    pitch.container.style.left = Math.round( ( window.innerWidth - pitch.container.clientWidth ) / 2 ) + "px";

    tilt.container.style.top = Math.round( ( window.innerHeight - tilt.container.clientHeight ) / 2 ) + "px";
    tilt.container.style.left = Math.round( ( window.innerWidth - tilt.container.clientWidth ) / 2 ) + "px";

    temperature.container.style.left = ( ( window.innerWidth / 4 ) - ( temperature.container.clientWidth / 2 ) ) + "px";
    temperature.container.style.top = ( airspeed.container.offsetTop + airspeed.container.clientHeight - temperature.container.clientHeight ) + "px";

    humidity.container.style.left = ( ( ( window.innerWidth / 4 ) * 3 ) - ( humidity.container.clientWidth / 2 ) ) + "px";
    humidity.container.style.top = ( airspeed.container.offsetTop + airspeed.container.clientHeight - humidity.container.clientHeight ) + "px";
}

// Setup page load
window.addEventListener( "load", doWindowLoad );
window.addEventListener( "resize", doWindowResize );

// Setup map library load
google.maps.event.addDomListener( window, "load", doMapLoad );
</script>

</head>
<body>

<!-- Map -->
<div class="map"></div>

<!-- Airspeed -->
<div class="airspeed"></div>

<!-- Heading -->
<div class="heading"></div>

<!-- Altimeter -->
<div class="altimeter"></div>

<!-- Pitch -->
<div class="pitch"></div>

<!-- Tilt -->
<div class="tilt"></div>

<!-- Position -->
<div class="position"></div>

<!-- Temperature -->
<div class="dial temperature"></div>

<!-- Humidity -->
<div class="dial humidity"></div>

</body>
</html>